(function(){const V=window.top!==window.self,R=window.location.href;if((R.includes("heatmap.com")||R.includes("heatmapcore.com"))&&!window.allowedHeatmapSiteIds.includes(window.preHeatmapSiteId))return V?console.log(":white_check_mark: Likely loaded via Heatmap iframe proxy."):console.log(":warning: Loaded directly from Heatmap portal \u2014 may be embedded server-side."),!0;window.heatmapIsLoaded||(window.heatmapIsLoaded=!0,window.HeatmapInitFunction=function(){var q=0;return function(){const G=
++q;console.log(`%c [Heatmap] Initializing recording system (instance #${G})`,"background-color: #2196F3; color: #fff; padding: 5px;");const d={id:G,eventHandlers:{},intervals:{},initialized:!1};(function(H){const F=setInterval(()=>{"undefined"!==typeof window.HeatPreprocessorLoaded&&"object"===typeof window.globalFunctions&&0<Object.keys(window.globalFunctions).length&&"function"===typeof window.globalFunctions.getHeatmapCrossDomainCookie&&(clearInterval(F),H())},100);d.intervals.preprocessorCheck=
F})(function(){function H(){try{const m=window.generatedIdVisit||"unknown",A=[];for(let u=0;u<localStorage.length;u++){const B=localStorage.key(u);B&&B.startsWith("heatmap_page_count_")&&B!=="heatmap_page_count_"+m&&A.push(B)}A.forEach(u=>localStorage.removeItem(u))}catch(m){console.warn("Error cleaning up old page counts:",m)}}function F(m){function A(h){try{const n=BigInt(h).toString(16).padStart(32,"0");return`${n.slice(0,8)}-${n.slice(8,12)}-${n.slice(12,16)}-${n.slice(16,20)}-${n.slice(20,32)}`}catch(n){return"000000ab-0000-0000-0000-000000000000"}}
if(m&&0!==m.length){r("Processing events:",m);var u=window.generatedIdVisit||"unknown-visit-id",B=window.generatedIdloghsr||"unknown-log-id",I=window.heatmapHsrIds||window.heatmapSiteHsr||"unknown-hsr",J=window.heatmapSessionIds||"unknown-session-id",K=window.HeatmapRecordings.cachedAuth?.groupRecordingId||A(u)||"000000ab-0000-0000-0000-000000000000",L=(!0===window.IS_TQA_SESSION?"TQA":"")+(window.hrs_vidp||u),a=window.pageCount||0,b=(h,n=!1)=>h.map(l=>{l={...l};l.te&&"string"===typeof l.te&&!l.te.startsWith("https")&&
(l.te=encodeURIComponent(l.te));var k;if(k=(n?[5]:[5,6]).includes(l.ty)&&l.te&&!l.reused)k=l.te,k="string"===typeof k&&1E4<encodeURI(k).length;if(k){k=String(Math.random()).slice(2,18);var p=l.ty;if(u){var x=(new URL(window.location.origin)).hostname,M="January February March April May June July August September October November December".split(" "),N=(new Date).getMonth(),O=(new Date).getDate(),P=(new Date).getFullYear();k=`${window.availableMutationPath??`hmr-mutations/type-${p}/${P}/${M[N]}/${O}`}/${x}/${k}.json.gz`}else k=
null;if(k&&window.globalFunctions?.GzipWebWorker){k=W+k;r(`Processing large mutation data (${l.te.length/1024}KB) to S3: ${k}`);5===l.ty&&(p=E()||"",x=S(),window.HeatmapRecordings.saveInitialDOMData(p,x,window.location.href,window.heatmapSiteHsr||"",k));try{window.globalFunctions.GzipWebWorker(l.te,k),l.te=k,r(`Mutation data sent to S3: ${k}`)}catch(T){}}}l.page_cnt=a;return l}),c=window.location,e=`${c.hostname}${c.pathname}`.replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,"_");c=h=>({type:"events",hsr_vid:L,
_id:(!0===window.IS_TQA_SESSION?"TQA":"")+`${E()}-${B}`,_idv:u,_idl:B,hsr_ev:h,res:""+window.innerWidth+"x"+window.innerHeight,hsr_ti:"undefined"!==typeof v?v.getTimeSincePageReady():(new Date).getTime(),efs_path:e,session_hsr:J,heatmap_hsr:I,group_recording_id:K,idsite:E(),page_cnt:a,hsr_return:window.isReturningUser||!1,url:window.location.href,urlref:document.referrer,transport:y.transport});if("undefined"!=typeof window.globalFunctions.GzipWebWorker){var f=b(m,!0);var g=c(f);g={Data:window.btoa(JSON.stringify(g))};
window.globalFunctions.GzipWebWorker(g,"https://srevents.heatmapcore.com/",!0,"recordings")}f=b(f??m);g=c(f);d.recordingClient.send(g,"[EVENTS]")}else r("No events to process")}function r(m,A="info"){if(window._heatmapRecordingsDebug||window._heatDEBUG){const u={info:"background-color: #2196F3; color: #fff; padding: 3px 5px;",warn:"background-color: #FF9800; color: #fff; padding: 3px 5px;",success:"background-color: #4CAF50; color: #fff; padding: 3px 5px;",error:"background-color: #F44336; color: #fff; padding: 3px 5px;"};
console.log(`%c [Heatmap Debug] ${m}`,u[A]||u.info)}}function E(){const m=localStorage.getItem("heatmap_id_site")||window.preHeatmapSiteId;return m?m:"unknown-idsite"}function S(){const m=window.screen.width;return 768>=m?"mobile":1024>=m?"tablet":"desktop"}function X(m){return new Promise(A=>setTimeout(A,m))}if(!d.initialized){d.initialized=!0;var Y=["button","submit","reset"],W=window.globalFunctions?.heatRetrieveStore("_heatmapConfigs","_heatMapEnvRecord")?.S3URL||"https://heatmap-project-2022.s3.us-west-2.amazonaws.com/",
y={transport:window.HeatmapRecordingTransport||"http",websocket:{url:"wss://ws.heatmap.com/ws/record/events?env=live",reconnectDelay:1E3,maxReconnectDelay:3E4,reconnectBackoffFactor:1.5,heartbeatInterval:3E4},http:{url:"https://ws.heatmap.com/",handshakeUrl:"record/handshake",eventUrl:"live/record/events",timeout:1E4}};d.recordingsEnabled=!0;d.captureKeystrokes=!0;d.captureMovements=!0;d.isRecording=!1;d.isRecordingMutations=!1;d.scrollMaxPercentage=0;d.max_scroll_height=d.maxScrollHeight=0;d.lastEventType=
null;d.lastEventTime=0;d.clicks=[];d.isPageVisible=!0;d.startRecordingMutationsRetryCount=2;d.mirror=null;d.initialDOM=null;d.initialWindowSize=null;d.mutationObserver=null;d.disconnectHandlers=[];d.recentUserActivityTimestamp=Date.now();d.recordingClient=null;d.intervals={lastResizeInterval:null,lastScrollInterval:null,lastMoveInterval:null,exitInterval:null,engagementInterval:null,inactivityInterval:null,healthCheckInterval:null};d.lastScroll=null;d.lastElementScroll=null;d.lastMove=null;d.lastResize=
null;d.userScrollData={ty:14,sh:0,smp:0,ti:0,current_smp:0,max_sp:0};(function(){try{const a="heatmap_page_count_"+(window.generatedIdVisit||"unknown");let b=parseInt(localStorage.getItem(a))||0;b++;localStorage.setItem(a,b.toString());window.pageCount=b;H();return b}catch(a){return console.warn("Error managing page count:",a),1}})();class m{static shouldMaskContent(a,b=!1){return a&&a.classList?a.classList.contains("mask-content")||b&&a.closest(".mask-content"):!1}static shouldMaskField(a,b=!1){return a&&
a.classList?a.classList.contains("mask-field")||b&&a.closest(".mask-field"):!1}static maskValue(a,b=!1){return a?b?"\u2022".repeat(a.length):a.replace(/\S/g,"X"):a}static getSecureImagePlaceholder(a){const b=a.getAttribute("width")||a.width||100;a=a.getAttribute("height")||a.height||100;return{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",width:b,height:a}}}class A{constructor(){this.nodeToId=new WeakMap;this.idToNode=new Map;
this.nextId=1}set(a,b=this.nextId++){this.nodeToId.set(a,b);this.idToNode.set(b,a);return b}get(a){return this.nodeToId.get(a)}getNode(a){return this.idToNode.get(a)}has(a){return this.nodeToId.has(a)}delete(a){const b=this.get(a);this.nodeToId.delete(a);this.idToNode.delete(b)}}class u{constructor(){this.added=new Set;this.removed=new Set;this.reparented=new Set;this.reordered=new Set;this.attributeChanges=new Map;this.characterDataChanges=new Set;this.shadowChanges=new Set}trackAttribute(a,b,c,
e){this.attributeChanges.has(a)||this.attributeChanges.set(a,new Map);this.attributeChanges.get(a).set(b,{oldValue:c,newValue:e})}trackShadowRoot(a,b,c=b.mode,e){this.shadowChanges.add({host:a,operation:"attach",mode:c,shadowRootId:e||`shadow-${a}-${Date.now()}`})}trackShadowUpdate(a,b,c="update"){this.shadowChanges.add({host:a,operation:c,shadowRootId:b||`shadow-${a}-${Date.now()}`})}}class B{constructor(a,b,c={}){this.target=a;this.mirror=b;this.options={maskSensitiveData:!0,trackReordering:!0,
securityLevel:"high",trackShadowDOM:!0,...c};this.knownNodes=new A;this.changeTracker=new u;this.shadowRootMap=new WeakMap;this.mirror.shadowChanges=this.mirror.shadowChanges||[];this._originalAttachShadow=Element.prototype.attachShadow}setupObserver(){this.mutationObserver||(this.mutationObserver=new MutationObserver(this.handleMutations.bind(this)));this.mutationObserver.observe(this.target,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0})}async initialize(){var a=
E()||"",b=S();a=await window.HeatmapRecordings.fetchInitialDOMData(a,b,window.location.href,window.heatmapSiteHsr||"");b=!1;a?.success&&a?.paths&&0<a?.paths.length&&(this.mirror.initializeWithExistingInitialDOM(a.paths[0]),b=!0);a?.availablePath&&(window.availableMutationPath=a.availablePath);this.options.trackShadowDOM&&(this.findExistingShadowRoots(this.target),await new Promise(c=>setTimeout(c,50)),this.patchShadowDOM(),this.mirror.shadowChanges.length&&(this.mirror.applyChanged([],[],[],[],this.mirror.shadowChanges),
this.mirror.shadowChanges=[]));if(!b){a=this.serializeNode(this.target).id;b=[];for(let c=this.target.firstChild;c;c=c.nextSibling)b.push(this.serializeNode(c,!0));this.mirror.initialize(a,b);await new Promise(c=>setTimeout(c,50));return a}}patchShadowDOM(){if(this.options.trackShadowDOM)try{const a=this;Element.prototype.attachShadow=function(...b){const c=a._originalAttachShadow.apply(this,b);a.trackShadowRoot(this,c,b[0]?.mode||"open");return c}}catch(a){console.warn("Error patching attachShadow:",
a)}}findExistingShadowRoots(a){if(this.options.trackShadowDOM)try{a=[];const b=new Set(["VIDEO","AUDIO","SELECT","DETAILS"]),c=document.createTreeWalker(document,NodeFilter.SHOW_ELEMENT,null,!1);let e=c.currentNode;for(;e;){const f=e.tagName;f&&(f.includes("-")||b.has(f))&&a.push(e);e=c.nextNode()}a.forEach(f=>{f.shadowRoot&&this.trackShadowRoot(f,f.shadowRoot)})}catch(b){console.warn("Error finding shadow roots:",b)}}trackShadowRoot(a,b,c=b.mode){if(this.options.trackShadowDOM)try{this.mutationObserver||
(this.mutationObserver=new MutationObserver(this.handleMutations.bind(this)));const e=this.knownNodes.get(a)||this.knownNodes.set(a);this.shadowRootIds||(this.shadowRootIds=new Map);const f=`shadow-${e}-${Date.now()}`;this.shadowRootIds.set(b,f);this.shadowRootMap.set(b,e);this.mutationObserver.observe(b,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0});const g=Array.from(b.childNodes).map(n=>this.serializeNode(n,!0)).filter(Boolean),h=this.options.trackShadowDOM?
this.extractShadowStyles(b):[];this.mirror.shadowChanges.push({targetId:e,operation:"attach",mode:c,content:g,shadowRootId:f,styles:h});this.changeTracker.trackShadowRoot(e,b,c,f)}catch(e){console.warn("Error tracking shadow root:",e)}}isInShadowDOM(a){if(!this.options.trackShadowDOM||!a)return!1;try{if(a instanceof ShadowRoot)return!0;let b=a.parentNode;for(;b;){if(b instanceof ShadowRoot)return!0;b=b.parentNode}}catch(b){}return!1}getShadowRootInfo(a){if(!this.options.trackShadowDOM||!a)return null;
try{if(a instanceof ShadowRoot){const c=this.knownNodes.get(a.host);if(c)return{root:a,host:a.host,hostId:c}}let b=a.parentNode;for(;b;){if(b instanceof ShadowRoot){const c=this.knownNodes.get(b.host);if(c)return{root:b,host:b.host,hostId:c}}b=b.parentNode}}catch(b){}return null}updateAffectedShadowRoots(a){if(this.options.trackShadowDOM)try{const b=new Set;for(const c of a){const e=this.getShadowRootInfo(c.target);if(e&&!b.has(e.hostId)){b.add(e.hostId);const f=this.shadowRootIds&&this.shadowRootIds.get(e.root),
g=Array.from(e.root.childNodes).map(h=>this.serializeNode(h,!0)).filter(Boolean);this.mirror.shadowChanges.push({targetId:e.hostId,operation:"update",mode:e.root.mode,content:g,shadowRootId:f||`shadow-${e.hostId}-${Date.now()}`});this.changeTracker.trackShadowUpdate(e.hostId,f)}}}catch(b){console.warn("Error updating shadow roots:",b)}}serializeNode(a,b=!1){if(!a)return null;var c=this.knownNodes.get(a);if(void 0!==c)return{id:c};c={id:this.knownNodes.set(a),nodeType:a.nodeType};switch(a.nodeType){case 1:c.tagName=
a.tagName;c.attributes=this.getSecureAttributes(a);a.hasAttribute("style")&&this.options.trackShadowDOM&&(c.style=a.getAttribute("style"));a.hasAttribute("class")&&this.options.trackShadowDOM&&(c.className=a.className);if(this.options.trackShadowDOM&&a.shadowRoot&&(c.hasShadow=!0,c.shadowMode=a.shadowRoot.mode,c.shadowRootId=`shadow-${c.id}-${Date.now()}`,this.shadowRootIds||(this.shadowRootIds=new Map),this.shadowRootIds.set(a.shadowRoot,c.shadowRootId),this.options.trackShadowDOM&&(c.shadowStyles=
this.extractShadowStyles(a.shadowRoot)),b)){c.shadowChildren=[];for(let e=a.shadowRoot.firstChild;e;e=e.nextSibling)c.shadowChildren.push(this.serializeNode(e,!0))}if(b&&a.childNodes.length)for(c.childNodes=[],a=a.firstChild;a;a=a.nextSibling)c.childNodes.push(this.serializeNode(a,!0));break;case 3:c.textContent=this.getSecureTextContent(a);break;case 9:if(b&&a.childNodes.length)for(c.childNodes=[],a=a.firstChild;a;a=a.nextSibling)c.childNodes.push(this.serializeNode(a,!0));break;case 10:c.name=a.name,
c.publicId=a.publicId,c.systemId=a.systemId}return c}getSecureAttributes(a){const b={};if(!a.attributes)return b;for(const {name:c,value:e}of a.attributes)this.shouldMaskAttribute(a,c)?b[c]=this.maskAttributeValue(a,c,e):b[c]=e;return b}shouldMaskAttribute(a,b){const c=["value","placeholder","data-value"];return this.options.maskSensitiveData&&(m.shouldMaskField(a)||c.includes(b))}maskAttributeValue(a,b,c){return"value"===b&&"INPUT"===a.tagName?m.maskValue(c,"password"===a.type):m.maskValue(c)}getSecureTextContent(a){return this.options.maskSensitiveData&&
m.shouldMaskContent(a)?m.maskValue(a.textContent):a.textContent}handleMutations(a){const b=this.processMutations(a);if(this.options.trackShadowDOM){var c=new Set;const e=new Map;for(const f of a)if(a=this.getShadowRootInfo(f.target))e.has(a.root)||e.set(a.root,{hostId:a.hostId,root:a.root}),"attributes"!==f.type||"style"!==f.attributeName&&"class"!==f.attributeName||c.add(f.target);0<e.size&&e.forEach(f=>{const g=Array.from(f.root.childNodes).map(n=>this.serializeNode(n,!0)).filter(Boolean),h=this.extractShadowStyles(f.root);
this.mirror.shadowChanges.push({targetId:f.hostId,operation:"update",mode:f.root.mode,content:g,styles:h})})}c=this.mirror.shadowChanges&&0<this.mirror.shadowChanges.length?[...this.mirror.shadowChanges]:[];0<c.length&&(this.mirror.shadowChanges=[]);(this.hasSignificantChanges(b)||0<c.length)&&this.mirror.applyChanged(b.removed,b.addedOrMoved,b.attributes,b.text,c)}extractShadowStyles(a){const b=[];try{const c=a.querySelectorAll("style");Array.from(c).forEach(f=>{b.push({type:"inline",content:f.textContent})});
const e=a.querySelectorAll("[style]");Array.from(e).forEach(f=>{b.push({type:"attribute",element:this.serializeNode(f),content:f.getAttribute("style")})});a.adoptedStyleSheets&&0<a.adoptedStyleSheets.length&&a.adoptedStyleSheets.forEach(f=>{try{const g=Array.from(f.cssRules).map(h=>h.cssText).join("\n");b.push({type:"adopted",content:g})}catch(g){}})}catch(c){console.warn("Error extracting shadow styles:",c)}return b}processMutations(a){const b={removed:[],addedOrMoved:[],attributes:[],text:[]};for(const c of a)switch(c.type){case "childList":this.processChildListMutation(c,
b);break;case "attributes":this.processAttributeMutation(c,b);break;case "characterData":this.processCharacterDataMutation(c,b)}return b}processChildListMutation(a,b){if(this.options.trackShadowDOM||!this.isInShadowDOM(a.target))b.removed.push(...Array.from(a.removedNodes).map(c=>this.serializeNode(c))),b.addedOrMoved.push(...Array.from(a.addedNodes).map(c=>{const e=this.serializeNode(c,!0);e.previousSibling=this.serializeNode(c.previousSibling);e.parentNode=this.serializeNode(c.parentNode);return e}))}processAttributeMutation(a,
b){if(this.options.trackShadowDOM||!this.isInShadowDOM(a.target)){var c=a.target;b.attributes.push({node:this.serializeNode(c),name:a.attributeName,value:this.getSecureAttributes(c)[a.attributeName]})}}processCharacterDataMutation(a,b){!this.options.trackShadowDOM&&this.isInShadowDOM(a.target)||b.text.push({node:this.serializeNode(a.target),textContent:this.getSecureTextContent(a.target)})}hasSignificantChanges(a){return Object.values(a).some(b=>0<b.length)}disconnect(){this.mutationObserver&&this.mutationObserver.disconnect();
if(this.options.trackShadowDOM&&this._originalAttachShadow)try{Element.prototype.attachShadow=this._originalAttachShadow}catch(a){console.warn("Error restoring attachShadow:",a)}}cleanup(){this.disconnect();this.shadowRootMap=this.changeTracker=this.knownNodes=null;this.shadowRootIds&&(this.shadowRootIds.clear(),this.shadowRootIds=null);this.mirror=this.target=null}}var v={getTimeSincePageReady:function(){return(new Date).getTime()-("undefined"===typeof window.pre_start_time?window.HeatmapTracker?.HeatmapSessionRecording?.utils?.getTimeSincePageReady()||
0:window.pre_start_time)},debounce:function(a,b){let c;return function(...e){clearTimeout(c);c=setTimeout(()=>a.apply(this,e),b)}},isRageClick:function(a,b){try{3<=a.length&&a.shift();a.push(b);if(3>a.length)return!1;let c=b=!0,e=!0;for(let f=1;f<a.length;f++)if(e=a[f].s===a[f-1].s,b=b&&250>=Math.abs(a[f].ti-a[f-1].ti),c=(c=c&&50>=Math.abs(a[f].x-a[f-1].x))&&50>=Math.abs(a[f].y-a[f-1].y),!b||!c||!e)return!1;return e&&b&&c}catch(c){return console.warn("Error in isRageClick:",c),!1}},cleanupSelector:function(a){if(!a)return a;
a=window.globalFunctions?.heatmapReplaceUUIDInSelector?window.globalFunctions.heatmapReplaceUUIDInSelector(a):a.replace(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,"*");window.shouldCleanupSelectors&&window.globalFunctions?.HeatreplaceComplexWithNthChild&&(a=window.globalFunctions.HeatreplaceComplexWithNthChild(a));return a},getParentWithDataAttribute:function(a){return window.getParentDataAttribute?window.getParentDataAttribute(a):a},removeNthChild:function(a){return a?a.split(" > ").map(b=>
b.replace(/sticky-header:nth-child\(\d+\)/,"sticky-header")).join(" > "):a}},t={getScrollTop:function(){return document.documentElement.scrollTop||document.body.scrollTop},getScrollLeft:function(){return document.documentElement.scrollLeft||document.body.scrollLeft},getDocumentHeight:function(){return document.body?Math.max(document.body.offsetHeight,document.body.scrollHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,1):window.innerHeight},
getDocumentWidth:function(){return document.body?Math.max(document.body.offsetWidth,document.body.scrollWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth,document.documentElement.scrollWidth,1):window.innerWidth},getWindowSize:function(){return{width:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,height:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}},getScrollPercent:function(){const a=document.documentElement,
b=document.body;return(a.scrollTop||b.scrollTop)/((a.scrollHeight||b.scrollHeight)-a.clientHeight)*100},getScrollDepthPercent:function(){return(window.scrollY||document.documentElement.scrollTop)/(document.documentElement.scrollHeight-window.innerHeight)*100},getTagName:function(a){return a&&a.tagName?String(a.tagName).toLowerCase():null},getCssClasses:function(a){return a&&a.className?"string"===typeof a.className?a.className.trim().split(/\s+/):[]:[]},getHeight:function(a){return!a||9!==a.nodeType&&
"HTML"!==a.tagName?a===window?document.documentElement.clientHeight:Math.max(a.scrollHeight,a.offsetHeight,0):this.getDocumentHeight()},getWidth:function(a){return!a||9!==a.nodeType&&"HTML"!==a.tagName?a===window?document.documentElement.clientWidth:Math.max(a.scrollWidth,a.offsetWidth,0):this.getDocumentWidth()},getOffset:function(a){if(!a.getBoundingClientRect)return{top:0,left:0,width:0,height:0};const b=(a.ownerDocument||document).documentElement,c=a.getBoundingClientRect();return{top:Math.floor(c.top)+
(window.pageYOffset||document.scrollTop||0)-(b.clientTop||0),left:Math.floor(c.left)+(window.pageXOffset||document.scrollLeft||0)-(b.clientLeft||0),width:Math.max(c.width,this.getWidth(a)),height:Math.max(c.height,this.getHeight(a))}},getSelector:function(a){try{if(!a)return null;if(window.clicksHandler?.cssPath){var b=window.clicksHandler.cssPath(a,!1),c=null;try{c=document.querySelector(b)}catch(g){b=b.replace(/#[^\s>]+/,""),c=document.querySelector(b)}if(window.globalFunctions?.heatHasBeforeOrAfterPseudoElement&&
window.globalFunctions.heatHasBeforeOrAfterPseudoElement(c)&&!window.globalFunctions.heatDoesElementHaveChildren(c)){var e=window.getComputedStyle(c,"::after"),f=c.offsetParent;const g=c.parentElement;f&&"BODY"!==f.tagName&&e&&"absolute"===e.position&&"0px"===e.left&&"0px"===e.right&&"0px"===e.bottom&&(b="li"===g.tagName.toLowerCase()&&"ul"===f.tagName.toLowerCase()?window.clicksHandler.cssPath(g):window.clicksHandler.cssPath(f))}window.clicksHandler.simplifyAndJoinSelectors&&(b=window.clicksHandler.simplifyAndJoinSelectors(b));
return b}for(b=[];a&&a.nodeType===Node.ELEMENT_NODE;){c=a.nodeName.toLowerCase();if(a.id){c+=`#${a.id}`;b.unshift(c);break}else{e=a;for(f=1;e.previousElementSibling;)e=e.previousElementSibling,e.nodeName.toLowerCase()===c&&f++;1!==f&&(c+=`:nth-of-type(${f})`)}b.unshift(c);a=a.parentNode}return b.join(" > ")}catch(g){return console.warn("Error getting selector:",g),null}},isAllowedInputType:function(a){return a.type&&-1!==Y.indexOf(a.type)&&!a.hasAttribute("data-piwik-mask")&&!a.hasAttribute("data-heatmap-mask")},
shouldMaskField:function(a,b=!0){if(!a)return!1;let c=a.getAttribute?.("type");c=c?String(c).toLowerCase():"text";if(this.isAllowedInputType(a))return!1;const e="radio"===c||"checkbox"===c||a.nodeName&&"SELECT"===a.nodeName;if(a.hasAttribute("data-piwik-mask")||a.hasAttribute("data-heatmap-mask"))return!0;if(e||a.hasAttribute("data-heatmap-unmask"))return!1;if(b)for(b=a.parentNode;b;){if("function"===typeof b.hasAttribute){if(b.hasAttribute("data-piwik-mask")||b.hasAttribute("data-heatmap-mask"))return!0;
if(b.hasAttribute("data-heatmap-unmask"))return!1}b=b.parentNode}return"text"===c||"password"===c||"email"===c||"tel"===c||"hidden"===c||"TEXTAREA"===a.nodeName},shouldMaskContent:function(a,b=!1){if(!a)return!1;if(a.tagName&&"FORM"!==a.tagName&&a.hasAttribute("data-heatmap-mask"))return!0;if(b)for(b=a.parentNode;b&&("#text"!==a.nodeName||!b.hasAttribute("data-heatmap-unmask"));){if("FORM"!==b.tagName&&b.hasAttribute("data-heatmap-mask"))return!0;b=b.parentNode}return!1},getMaskedTextContent:function(a,
b=!1,c=!1){return a?a.parentNode&&"TEXTAREA"===a.parentNode.tagName&&(b||this.shouldMaskField(a,!1))||c||this.shouldMaskContent(a,!1)?this.maskFormField(a.textContent.trim()):a.textContent:""},maskFormField:function(a,b=!1){return a?a.startsWith("data-heatmap-unmask:::")?a.substr(22):b?"\u2022".repeat(String(a).length):String(a).replace(/./g,"*"):a}};class I{constructor(a={}){this.options={handshakeUrl:`${a.url}${a.handshakeUrl}`,eventUrl:`${a.url}${a.eventUrl}`,timeout:a.timeout||1E4,debug:a.debug||
!1};this.authenticated=!1;this.eventHandlers={open:[],handshakeResponse:[],error:[]};this.connected=!0;this.send=this.send.bind(this);this.handleHandshakeResponse=this.handleHandshakeResponse.bind(this);this.performHandshake()}async performHandshake(){window.HeatmapRecordings.loadCachedAuth();if(window.HeatmapRecordings.cachedAuth&&window.HeatmapRecordings.cachedAuth.shouldRecord)this.authenticated=!0,this.triggerEvent("open",{});else try{this.log("Performing HTTP handshake:",this.options.handshakeUrl);
const a=await this.sendHandshake();a&&void 0!==a.shouldRecord&&this.handleHandshakeResponse(a)}catch(a){this.log("Handshake failed:",a),this.triggerEvent("error",a)}}async send(a,b="",c=0,e=8,f=1){if(!this.authenticated)return this.log("Not authenticated, skipping send"),!1;try{if("[EVENTS]"===b||b.includes("events")){var g="string"===typeof a?JSON.parse(a):{...a};const h="string"===typeof a?a:JSON.stringify(g);if(navigator.sendBeacon){if(navigator.sendBeacon(this.options.eventUrl,h))return this.log(`Event sent via sendBeacon${0<
c?" (chunk "+c+")":""}:`,b),!0;this.log(`sendBeacon failed, payload size is ~${Math.round(h.length/1024)}KB (64KB limit)`);g&&Array.isArray(g.hsr_ev)&&this.log(`Current payload contains ${g.hsr_ev.length} events`);if(g&&Array.isArray(g.hsr_ev)&&1<g.hsr_ev.length&&g.hsr_ev.length>f&&c<e){const n=Math.ceil(g.hsr_ev.length/2),l=g.hsr_ev.slice(0,n),k=g.hsr_ev.slice(n);this.log(`Splitting events array into chunks: ${l.length} and ${k.length} events`);a={...g,hsr_ev:l};g={...g,hsr_ev:k};await X(500);const p=
await this.send(a,b,c+1,e,f),x=await this.send(g,b,c+2,e,f);return p||x}this.log("Could not split further or not an events array, falling back to fetch")}fetch(this.options.eventUrl,{method:"POST",body:h}).catch(n=>{this.log("Fetch fallback failed:",n)});return!0}this.log("Non-event message ignored:",b);return!0}catch(h){return this.log("Error sending message:",h),!1}}async sendHandshake(){var a={type:"handshake",siteId:E()||"",visitId:window.generatedIdVisit||"",loghsrId:window.generatedIdloghsr||
"",url:window.location.href,isTQA:!0===window.IS_TQA_SESSION,transport:"http"};this.log("Sending handshake:",a);a=await this.makeRequest(this.options.handshakeUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!a.ok)throw Error(`Handshake failed: HTTP ${a.status}`);return await a.json()}handleHandshakeResponse(a){this.log("Handshake response:",a);try{localStorage.setItem("heatmap_recording_auth",JSON.stringify({shouldRecord:a.shouldRecord,groupRecordingId:a.groupRecordingId,
idVisit:window.generatedIdVisit,timestamp:Date.now(),expiryHours:24})),this.log("Stored auth in localStorage:",a.shouldRecord)}catch(b){this.log("Could not save auth to localStorage:",b)}window.HeatmapRecordings.loadCachedAuth();window.HeatmapRecordings.cachedAuth?.shouldRecord?(this.log("Server authorized recording - HTTP client ready"),this.authenticated=!0,this.triggerEvent("open",{}),this.triggerEvent("handshakeResponse",a)):(this.log("Server declined recording"),this.authenticated=!1,window.HeatmapRecordings.stopRecording(),
window.HeatmapRecordings.stopRecordingMutations())}async makeRequest(a,b){const c=new AbortController,e=setTimeout(()=>c.abort(),this.options.timeout);try{const f=await fetch(a,{...b,signal:c.signal});clearTimeout(e);return f}catch(f){throw clearTimeout(e),f;}}disconnect(){this.log("HTTP client disconnect requested");this.authenticated=this.connected=!1}on(a,b){this.eventHandlers[a]||(this.eventHandlers[a]=[]);this.eventHandlers[a].push(b);return this}off(a,b){if(!this.eventHandlers[a])return this;
this.eventHandlers[a]=this.eventHandlers[a].filter(c=>c!==b);return this}triggerEvent(a,b){this.eventHandlers[a]&&this.eventHandlers[a].forEach(c=>{try{c(b)}catch(e){this.log(`Error in ${a} handler:`,e)}})}log(...a){(this.options.debug||window._heatDEBUG||window._heatmapRecordingsDebug)&&console.log("%c [HttpRecordingClient]","background-color: #FF5722; color: #fff; padding: 5px;",...a)}}class J{constructor(a={}){this.options={url:a.url||"wss://ws.heatmap.com/ws/record/events?env=live",reconnectDelay:a.reconnectDelay||
1E3,maxReconnectDelay:a.maxReconnectDelay||3E4,reconnectBackoffFactor:a.reconnectBackoffFactor||1.5,heartbeatInterval:a.heartbeatInterval||3E4,debug:a.debug||!1,autoConnect:!1!==a.autoConnect};this.socket=null;this.intentionalDisconnect=this.connected=!1;this.reconnectAttempts=0;this.heartbeatInterval=this.reconnectTimeout=null;this.eventHandlers={open:[],message:[],error:[],close:[],reconnect:[],handshakeResponse:[]};this.connect=this.connect.bind(this);this.disconnect=this.disconnect.bind(this);
this.send=this.send.bind(this);this.handleOpen=this.handleOpen.bind(this);this.handleMessage=this.handleMessage.bind(this);this.handleError=this.handleError.bind(this);this.handleClose=this.handleClose.bind(this);this.reconnect=this.reconnect.bind(this);this.sendHandshake=this.sendHandshake.bind(this);this.sendHeartbeat=this.sendHeartbeat.bind(this);!1!==a.autoConnect&&this.connect()}connect(){window.HeatmapRecordings.loadCachedAuth();if(window.HeatmapRecordings.cachedAuth&&!window.HeatmapRecordings.cachedAuth.shouldRecord)window.HeatmapRecordings.stopRecording(),
window.HeatmapRecordings.stopRecordingMutations();else if(!this.socket||this.socket.readyState!==WebSocket.CONNECTING&&this.socket.readyState!==WebSocket.OPEN){this.intentionalDisconnect=!1;try{this.log("Connecting to WebSocket server:",this.options.url),this.socket=new WebSocket(this.options.url),this.socket.addEventListener("open",this.handleOpen),this.socket.addEventListener("message",this.handleMessage),this.socket.addEventListener("error",this.handleError),this.socket.addEventListener("close",
this.handleClose)}catch(a){this.log("Error creating WebSocket:",a),this.reconnect()}}else this.log("Socket already connecting or connected")}disconnect(){this.log("Disconnecting from WebSocket server");this.intentionalDisconnect=!0;this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null);this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null);this.socket&&(this.socket.close(1E3,"Intentional disconnect"),this.socket=null);this.connected=
!1}send(a,b=""){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return this.log("Cannot send message, socket not open"),!1;try{const c="string"===typeof a?a:JSON.stringify(a);this.socket.send(c);this.log("Sent message:",b||"message",a);return!0}catch(c){return this.log("Error sending message:",c),!1}}handleOpen(a){this.log("WebSocket connection established");this.connected=!0;this.reconnectAttempts=0;window.HeatmapRecordings.loadCachedAuth();window.HeatmapRecordings.cachedAuth||(this.log("No cached auth, sending handshake"),
this.sendHandshake());this.triggerEvent("open",a)}handleMessage(a){let b;try{b=JSON.parse(a.data),this.log("Received message:",b)}catch(c){this.log("Received non-JSON message:",a.data),b=a.data}!b||"handshake_response"!==b.type&&"undefined"===typeof b.shouldRecord||this.handleHandshakeResponse(b);this.triggerEvent("message",{originalEvent:a,data:b})}handleError(a){this.log("WebSocket error:",a);this.triggerEvent("error",a)}handleClose(a){this.log("WebSocket connection closed:",a.code,a.reason);this.connected=
!1;this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null);this.triggerEvent("close",a);this.intentionalDisconnect||this.reconnect()}reconnect(){if(this.intentionalDisconnect)this.log("Not reconnecting due to intentional disconnect");else{this.reconnectTimeout&&clearTimeout(this.reconnectTimeout);this.reconnectAttempts++;var a=Math.min(this.options.maxReconnectDelay,this.options.reconnectDelay*Math.pow(this.options.reconnectBackoffFactor,this.reconnectAttempts-
1)),b=.2*a;a=a-b+Math.random()*b*2;this.log(`Reconnecting in ${Math.round(a)}ms (attempt ${this.reconnectAttempts})`);this.reconnectTimeout=setTimeout(()=>{this.triggerEvent("reconnect",{attempts:this.reconnectAttempts});this.connect()},a)}}sendHandshake(){const a=E()||"";this.send({type:"handshake",siteId:a,visitId:window.generatedIdVisit||"",loghsrId:window.generatedIdloghsr||"",url:window.location.href,isTQA:!0===window.IS_TQA_SESSION,transport:"websocket"},"handshake")}handleHandshakeResponse(a){this.log("Handshake response:",
a);try{localStorage.setItem("heatmap_recording_auth",JSON.stringify({shouldRecord:a.shouldRecord,groupRecordingId:a.groupRecordingId,idVisit:window.generatedIdVisit,timestamp:Date.now(),expiryHours:24})),this.log("Stored auth in localStorage:",a.shouldRecord)}catch(b){this.log("Could not save auth to localStorage:",b)}window.HeatmapRecordings.loadCachedAuth();window.HeatmapRecordings.cachedAuth?.shouldRecord?(this.log("Server authorized recording - starting recording modules"),this.triggerEvent("handshakeResponse",
a)):(this.log("Server declined recording - disconnecting"),window.HeatmapRecordings.stopRecording(),window.HeatmapRecordings.stopRecordingMutations(),this.disconnect())}sendHeartbeat(){const a={type:"heartbeat",timestamp:(new Date).toISOString(),visitId:window.generatedIdVisit||""};this.send(a,"heartbeat")}on(a,b){this.eventHandlers[a]||(this.eventHandlers[a]=[]);this.eventHandlers[a].push(b);return this}off(a,b){if(!this.eventHandlers[a])return this;this.eventHandlers[a]=this.eventHandlers[a].filter(c=>
c!==b);return this}triggerEvent(a,b){this.eventHandlers[a]&&this.eventHandlers[a].forEach(c=>{try{c(b)}catch(e){this.log(`Error in ${a} handler:`,e)}})}log(...a){(this.options.debug||window._heatDEBUG||window._heatmapRecordingsDebug)&&console.log("%c [RecordingWebsocketClient]","background-color: #43a047; color: #fff; padding: 5px;",...a)}}class K{constructor(){this.scrollEvents="scroll resize wheel touchmove DOMMouseScroll mousewheel keydown".split(" ");this.moveEvents=["mousemove","touchmove"];
this.clickEvents=["mousedown","click"];this.exitPageEvents=["beforeunload","pagehide","visibilitychange"];this.lastResize=this.lastMove=this.lastElementScroll=this.lastScroll=null;this.scrollMaxPercentage=0;this.isRecordingMutations=this.isRecording=!1;this.startRecordingMutationsRetryCount=2;this.serializer=this.initialDOM=this.mirror=this.exitInterval=this.lastMoveInterval=this.lastResizeInterval=this.lastScrollInterval=null;this.onScroll=this.onScroll.bind(this);this.onClick=this.onClick.bind(this);
this.onMove=this.onMove.bind(this);this.onResize=v.debounce(this.onResize.bind(this),100);this.onFormChange=v.debounce(this.onFormChange.bind(this),100);this.onExit=this.onExit.bind(this)}init(){d.initialWindowSize=t.getWindowSize()}startRecording(){d.recordingsEnabled&&!this.isRecording&&(this.isRecording=!0,this.lastScrollInterval=setInterval(()=>{if(this.lastScroll){var a=this.lastScroll;this.lastScroll=null;this.recordData({ti:a.time,ty:3,x:a.scrollX,y:a.scrollY})}this.lastElementScroll&&(a=this.lastElementScroll,
this.lastElementScroll=null,this.recordData({ti:a.time,ty:12,s:a.selector,x:a.scrollX,y:a.scrollY}))},50),d.intervals.lastScrollInterval=this.lastScrollInterval,this.lastResizeInterval=setInterval(()=>{if(this.lastResize){const a=this.lastResize;this.lastResize=null;this.recordData({ti:a.ti,ty:4,x:a.width,y:a.height})}},200),d.intervals.lastResizeInterval=this.lastResizeInterval,this.lastMoveInterval=setInterval(()=>{if(this.lastMove&&d.captureMovements){const a=this.lastMove;this.lastMove=null;this.recordData({ti:a.time,
ty:1,s:a.selector,x:a.offsetx,y:a.offsety})}},100),d.intervals.lastMoveInterval=this.lastMoveInterval,this.scrollEvents.forEach(a=>{window.addEventListener(a,this.onScroll,!0)}),d.captureMovements&&this.moveEvents.forEach(a=>{window.addEventListener(a,this.onMove,!0)}),this.exitPageEvents.forEach(a=>{window.addEventListener(a,this.onExit,!0)}),this.exitInterval=setInterval(()=>{},45E3),d.intervals.exitInterval=this.exitInterval,window.addEventListener("change",this.onFormChange,!0),window.addEventListener("resize",
this.onResize,!0))}startRecordingMutations(){if(d.recordingsEnabled&&window.MutationObserver&&!this.isRecordingMutations){this.isRecordingMutations=!0;try{this.mirror={shadowChanges:[],initialize:(a,b)=>{a={ty:5,ti:0,te:JSON.stringify({rootId:a,children:b})};this.initialDOM||(this.initialDOM=a.te);this.recordData(a)},initializeWithExistingInitialDOM:a=>{if(a){const b={ty:5,ti:0,te:a,reused:!0};this.initialDOM=a;this.recordData(b)}},applyChanged:(a,b,c,e,f)=>{const g=f||(this.mirror.shadowChanges&&
0<this.mirror.shadowChanges.length?[...this.mirror.shadowChanges]:[]);if(a.length||b.length||c.length||e.length||g.length){const h={ti:v.getTimeSincePageReady(),ty:6,te:{}};a.length&&(h.te.rem=a);b.length&&(h.te.adOrMo=b);c.length&&(h.te.att=c);e.length&&(h.te.text=e);g.length&&(h.te.shadow=g,!f&&this.mirror.shadowChanges&&(this.mirror.shadowChanges=[]));h.te=JSON.stringify(h.te);this.recordData(h)}},disconnect:()=>{this.serializer&&(this.serializer.disconnect(),this.serializer=null)}},this.serializer=
new B(document,this.mirror,{maskSensitiveData:!0,trackReordering:!0,securityLevel:"high",trackShadowDOM:!0,trackShadowStyles:!0}),this.mirror.serializer=this.serializer,(async()=>{try{await this.serializer.initialize(),this.serializer?.setupObserver()}catch(a){}})()}catch(a){console.warn(a),this.stopRecording(),this.stopRecordingMutations(),0<this.startRecordingMutationsRetryCount&&(this.startRecordingMutationsRetryCount--,setTimeout(()=>{this.startRecordingMutations();this.startRecording()},500))}}}handleVisibilityChange(){d.isPageVisible=
!document.hidden}recordData(a){d.recordingsEnabled&&window.HeatmapRecordings.srEventQueue&&window.HeatmapRecordings.srEventQueue.push(a)}stopRecording(){this.isRecording=!1;this.lastResizeInterval&&(clearInterval(this.lastResizeInterval),this.lastResizeInterval=null,d.intervals.lastResizeInterval=null);this.lastScrollInterval&&(clearInterval(this.lastScrollInterval),this.lastScrollInterval=null,d.intervals.lastScrollInterval=null);this.lastMoveInterval&&(clearInterval(this.lastMoveInterval),this.lastMoveInterval=
null,d.intervals.lastMoveInterval=null);this.exitInterval&&(clearInterval(this.exitInterval),this.exitInterval=null,d.intervals.exitInterval=null);this.scrollMaxPercentage=0;this.lastResize=this.lastMove=this.lastElementScroll=this.lastScroll=null;this.scrollEvents.forEach(a=>{window.removeEventListener(a,this.onScroll,!0)});this.moveEvents.forEach(a=>{window.removeEventListener(a,this.onMove,!0)});this.clickEvents.forEach(a=>{window.removeEventListener(a,this.onClick,!0)});this.exitPageEvents.forEach(a=>
{window.removeEventListener(a,this.onExit,!0)});window.removeEventListener("change",this.onFormChange,!0);window.removeEventListener("resize",this.onResize,!0)}stopRecordingMutations(){this.isRecordingMutations=!1;this.mirror&&(this.mirror.disconnect(),this.mirror=null);this.serializer&&(this.serializer.cleanup(),this.serializer=null);this.initialDOM=null}onScroll(a){var b=v.getTimeSincePageReady();d.recentUserActivityTimestamp=Date.now();if(a&&"scroll"===a.type&&a.target&&a.target!==document){var c=
a.target;if("undefined"!==typeof c.scrollTop){a=c.scrollTop;var e=c.scrollLeft,f=t.getWidth(c),g=t.getHeight(c);0>=f||0>=g||!(c=t.getSelector(c))||(this.lastElementScroll={time:b,selector:c,scrollY:parseInt(2E3*a/g,10),scrollX:parseInt(2E3*e/f,10)})}}else a=t.getScrollTop(),e=t.getScrollLeft(),f=t.getDocumentHeight(),g=t.getDocumentWidth(),d.max_scroll_height=f>d.max_scroll_height?f:d.max_scroll_height,this.lastScroll={time:b,scrollY:parseInt(2E3*a/f,10),scrollX:parseInt(2E3*e/g,10)},b=parseInt(10*
t.getScrollDepthPercent(),10),b>this.scrollMaxPercentage?(this.scrollMaxPercentage=b,d.maxScrollHeight=b):d.maxScrollHeight=this.scrollMaxPercentage,localStorage.setItem("userMaxScroll",d.maxScrollHeight)}onClick(a){var b=Date.now(),c=a.type;if(!(d.lastEventType&&c!==d.lastEventType&&100>b-d.lastEventTime)&&(d.lastEventType=c,d.lastEventTime=b,d.recentUserActivityTimestamp=b,a.target&&"undefined"!==typeof a.pageY&&"undefined"!==typeof a.pageX)){c=v.getTimeSincePageReady();this.lastMove=null;b=a.target.getRootNode()instanceof
ShadowRoot;var e=t.getSelector(a.target);if(e){var f=a.target.getBoundingClientRect(),g=f.top+(document.documentElement.scrollTop||document.body.scrollTop),h=parseInt((a.pageX-(f.left+(document.documentElement.scrollLeft||document.body.scrollLeft)))/f.width*2E3,10);f=parseInt((a.pageY-g)/f.height*2E3,10);h+=h%2;f+=f%2;c={ti:c,ty:2,s:e.replace(/"/g,""),x:h,y:f,ax:a.pageX,ay:a.pageY,name:a.target.tagName};if(window.globalFunctions?.calculateRusRud){const {rus:n,rud:l,ruap:k}=window.globalFunctions.calculateRusRud(a.target,
c.s);c.rus=window.shouldCleanupSelectors?window.globalFunctions.HeatreplaceComplexWithNthChild(k):k;c.rud=l;c.ruap=window.shouldCleanupSelectors?window.globalFunctions.HeatreplaceComplexWithNthChild(n):n}c.s=v.cleanupSelector(c.s);v.isRageClick(d.clicks,c)&&(c.meta1="rage");if(c.s&&window.globalFunctions?.validateHeatSelector?.(c.s)&&!isNaN(c.y)){if(!b)try{document.querySelector(c.s)}catch(n){}!b&&window.getParentDataAttribute&&(c.s=window.getParentDataAttribute(v.removeNthChild(c.s)));d.clicks.push(c);
this.recordData(c);window.globalFunctions?.getEventTagValue&&window.globalFunctions.getEventTagValue(c.s);localStorage.setItem("_HEATMAP_LAST_ELEMENT_CLICKED",JSON.stringify({...c,hsr:window.heatmapSiteHsr,idl:window.generatedIdloghsr}));window.globalObjects?.clicks&&window.globalObjects.clicks.push(c);"undefined"!==typeof window.userEventsCounter&&window.userEventsCounter++}}}}onMove(a){if(d.captureMovements&&a.clientY&&a.clientX&&a.pageX&&a.pageY){var b=document.elementFromPoint(a.clientX,a.clientY);
if(b){var c=v.getTimeSincePageReady();d.recentUserActivityTimestamp=Date.now();var e=t.getOffset(b),f=parseInt((a.pageX-e.left)/e.width*2E3,10);a=parseInt((a.pageY-e.top)/e.height*2E3,10);f=1===f%2?f+1:f;a=1===a%2?a+1:a;if(b=t.getSelector(b))void 0!==window.G&&window.G?this.lastMove={selector:b,offsetx:f,offsety:a,time:c}:(window.G=!0,this.recordData({ti:0,ty:1,s:b,x:f,y:a}))}}}onResize(){const a=t.getWindowSize();d.recentUserActivityTimestamp=Date.now();this.lastResize={ti:v.getTimeSincePageReady(),
width:a.width,height:a.height}}onFormChange(a){if(a.target){a=a.target;var b=t.getTagName(a);if(b){var c=v.getTimeSincePageReady();d.recentUserActivityTimestamp=Date.now();var e=10,f=!1;if("input"===b)b=a.getAttribute("type")?.toLowerCase(),"radio"===b||"checkbox"===b?f=!0:e=10;else if("textarea"!==b&&"select"!==b)return;if(d.captureKeystrokes||10!==e)if(b=t.getSelector(a)){var g="";f?g=a.checked?"1":"0":10===e&&void 0!==a.value&&(g=String(a.value),500<g.length&&(g=g.substr(0,500)),t.shouldMaskField(a,
!0)&&(g=t.maskFormField(g,"password"===a.getAttribute("type"))));this.recordData({ti:c,ty:e,s:b,te:g})}}}}onExit(a){a=v.getTimeSincePageReady();localStorage.setItem("prevHsr",window.heatmapSiteHsr);1E3<a&&window.HeatmapTracker?.HeatmapSessionRecording&&(window.HeatmapTracker.HeatmapSessionRecording.tracking.getPiwikTrackers().forEach(b=>{let c=[];b.HeatmapSessionRecording.Heatmap.data.length&&(c=b.HeatmapSessionRecording.Heatmap.data);b.HeatmapSessionRecording.Session.data.length&&(c=c.concat(b.HeatmapSessionRecording.Session.data));
b.HeatmapSessionRecording.Both.data.length&&(c=c.concat(b.HeatmapSessionRecording.Both.data));const e=b.HeatmapSessionRecording.Heatmap.hsrids.concat(b.HeatmapSessionRecording.Session.hsrids);window.HeatmapTracker.HeatmapSessionRecording.tracking.sendQueuedDataRequestNow(b,e,c,!0)}),window.exitEventSent=!0)}cleanup(){this.stopRecording();this.stopRecordingMutations();this.initialDOM=this.lastResize=this.lastMove=this.lastElementScroll=this.lastScroll=null;this.serializer&&(this.serializer.cleanup(),
this.serializer=null);this.mirror&&("function"===typeof this.mirror.disconnect&&this.mirror.disconnect(),this.mirror=null)}}class L{constructor(a={}){this.config={maxBatchSize:a.maxBatchSize||32,minBatchSize:a.minBatchSize||Math.floor(.3*(a.maxBatchSize||32)),processingDelay:a.processingDelay||4E3,adaptiveTiming:!1!==a.adaptiveTiming,minProcessingDelay:a.minProcessingDelay||4E3,maxProcessingDelay:a.maxProcessingDelay||8E3,watchIntervalMs:a.watchIntervalMs||500,sortEvents:!1!==a.sortEvents,maxHoldTime:a.maxHoldTime||
12E3,criticalEventTypes:a.criticalEventTypes||[2,10],mutationMergeWindow:a.mutationMergeWindow||0,...a};this.activeQueue=[];this.shadowQueue=[];this.processingLock=!1;this.eventIndex=0;this.processFnRef=this.watchInterval=null;this.clickTriggerEnabled=!1;this.lastMutationTimestamp=this.lastSendTime=0;this.process=this.process.bind(this);this.triggerImmediateProcessing=this.triggerImmediateProcessing.bind(this);this.mutationStats={total:0,merged:0,skipped:0,errors:0}}getMutationMergeStats(){const a=
0<this.mutationStats.total?(this.mutationStats.merged/this.mutationStats.total*100).toFixed(2):"0.00";return{...this.mutationStats,mergeRate:`${a}%`,mergeWindow:this.config.mutationMergeWindow}}mergeMutationEvents(a,b){if(6!==a.ty)return!1;this.mutationStats.total++;var c=Date.now();const e=c-this.lastMutationTimestamp;this.lastMutationTimestamp=c;if(e<=this.config.mutationMergeWindow&&0<b.length)for(c=b.length-1;0<=c;c--){const Q=b[c];if(6===Q.ty)try{const w=JSON.parse(Q.te),z=JSON.parse(a.te);var f=
(w.rem||[]).length,g=(w.adOrMo||[]).length,h=(w.att||[]).length,n=(w.text||[]).length,l=(w.shadow||[]).length||0,k=(z.rem||[]).length,p=(z.adOrMo||[]).length,x=(z.att||[]).length,M=(z.text||[]).length,N=(z.shadow||[]).length||0;const D={rem:[...(w.rem||[]),...(z.rem||[])],adOrMo:[...(w.adOrMo||[]),...(z.adOrMo||[])],att:[...(w.att||[]),...(z.att||[])],text:[...(w.text||[]),...(z.text||[])]};if(w.shadow||z.shadow)D.shadow=[...(w.shadow||[]),...(z.shadow||[])];var O=D.rem.length,P=D.adOrMo.length,T=
D.att.length,Z=D.text.length,aa=(D.shadow||[]).length;Q.te=JSON.stringify(D);this.mutationStats.merged++;r(`Merged mutation events (${e}ms gap):
                      Previous: rem=${f}, add=${g}, att=${h}, text=${n}, shadow=${l}
                      Current: rem=${k}, add=${p}, att=${x}, text=${M}, shadow=${N}
                      Merged: rem=${O}, add=${P}, att=${T}, text=${Z}, shadow=${aa}`,"success");return!0}catch(w){this.mutationStats.errors++;console.warn("Error merging mutation events:",w);r(`Error merging mutation events: ${w.message}`,"warn");break}}else this.mutationStats.skipped++,e>this.config.mutationMergeWindow?r(`Skipped merge: Time window exceeded (${e}ms > ${this.config.mutationMergeWindow}ms)`):0===b.length&&r("Skipped merge: Empty queue");return!1}addToQueue(a,b){if(this.config.sortEvents&&
0<b.length){const c=a.ti||0;let e=b.length;for(let f=0;f<b.length;f++)if((b[f].ti||0)>c){e=f;break}b.splice(e,0,a)}else b.push(a)}push(a){if(a){var b=this.processingLock?this.shadowQueue:this.activeQueue;this.mergeMutationEvents(a,b)||this.addToQueue(a,b);a=this.config.criticalEventTypes.includes(a.ty);b=this.length()>=this.config.maxBatchSize;(this.clickTriggerEnabled&&a||b)&&this.triggerImmediateProcessing()}}length(){return this.activeQueue.length+this.shadowQueue.length+(window.sessionEventQueue||
[]).length}watchForClicks(a=!0,b=[2]){this.clickTriggerEnabled=a;this.watchInterval&&(clearInterval(this.watchInterval),this.watchInterval=null);a&&(this.watchInterval=setInterval(()=>{const c=this.activeQueue.some(f=>b.includes(f.ty)),e=Array.isArray(window.sessionEventQueue)&&window.sessionEventQueue.some(f=>b.includes(f.ty));(c||e)&&this.triggerImmediateProcessing()},this.config.watchIntervalMs),d.intervals.watchInterval=this.watchInterval);return this}triggerImmediateProcessing(){this.processFnRef&&
!this.processingLock&&this.process(this.processFnRef,{processOneTime:!0})}process(a,b={}){if("function"!==typeof a)return Promise.reject(Error("Queue processing requires a callback function"));window.HeatmapRecordings.loadCachedAuth();if(window.HeatmapRecordings.cachedAuth&&!window.HeatmapRecordings.cachedAuth.shouldRecord){console.warn("Recording is disabled by cached auth settings, stop processing");this.processFnRef=null;const e=setInterval(()=>{window.HeatmapRecordings.loadCachedAuth();if(window.HeatmapRecordings.cachedAuth?.shouldRecord){console.log("Recording processing re-enabled by cached auth settings");
window.HeatmapRecordings.processEventQueue();var f=!0}else f=!1;f&&clearInterval(e)},5E3);return Promise.resolve()}if(!d.recordingClient||!d.recordingClient.connected)return Promise.reject(Error("Recording client not connected, cannot process queue"));this.processFnRef=a;if(this.processingLock)return Promise.resolve();const c={maxBatchSize:b.maxBatchSize||this.config.maxBatchSize,delay:b.delay||this._getAdaptiveDelay(),onComplete:b.onComplete||(()=>{}),onBatchComplete:b.onBatchComplete||(()=>{}),
processOneTime:b.processOneTime||!1};return new Promise(e=>{const f=()=>{this.processingLock=!0;if(window.HeatmapRecordings.cachedAuth?.shouldRecord){0===this.activeQueue.length&&0<this.shadowQueue.length&&(this.activeQueue=this.config.sortEvents?[...this.shadowQueue].sort((p,x)=>(p.ti||0)-(x.ti||0)):[...this.shadowQueue],this.shadowQueue=[]);var g=this.activeQueue.length;Array.isArray(window.sessionEventQueue)&&(g+=window.sessionEventQueue.length);var h=Date.now()-this.lastSendTime;const n=this.activeQueue.some(p=>
this.config.criticalEventTypes.includes(p.ty)),l=c.processOneTime,k=h>this.config.maxHoldTime;if(!(0<g&&(g>=this.config.minBatchSize||n||l||k))){this.processingLock=!1;!c.processOneTime&&0<g&&setTimeout(f,Math.max(1E3,this.config.maxHoldTime-h));return}g=this.activeQueue.splice(0,Math.min(c.maxBatchSize,this.activeQueue.length));Array.isArray(window.sessionEventQueue)&&0<window.sessionEventQueue.length&&(window.sessionEventQueue=window.sessionEventQueue.filter(p=>2==p.ty),h=c.maxBatchSize-g.length,
0<h&&g.push(...window.sessionEventQueue.splice(0,h)));this.config.sortEvents&&g.sort((p,x)=>(p.ti||0)-(x.ti||0));g=g.map(p=>{p.index=++this.eventIndex;return p});try{0<g.length&&(a(g),c.onBatchComplete(g.length),this.lastSendTime=Date.now(),(window._heatDEBUG||window._heatmapRecordingsDebug)&&console.log(`%c [EventQueue] Sent batch of ${g.length} events (min threshold: ${this.config.minBatchSize})`,"background-color: #2196F3; color: #fff; padding: 2px;")),0<g.filter(p=>[2,1,3].includes(p.ty)).length&&
(d.recentUserActivityTimestamp=Date.now())}catch(p){}}this.processingLock=!1;c.processOneTime?e():(g=this._getAdaptiveDelay(),setTimeout(f,g))};f()})}_getAdaptiveDelay(){return this.config.adaptiveTiming?this.config.minProcessingDelay+Math.floor(Math.random()*(this.config.maxProcessingDelay-this.config.minProcessingDelay)):this.config.processingDelay}getAll(){return[...this.activeQueue,...this.shadowQueue,...(Array.isArray(window.sessionEventQueue)?window.sessionEventQueue:[])]}clear(){this.activeQueue=
[];this.shadowQueue=[]}destroy(){this.watchInterval&&(clearInterval(this.watchInterval),this.watchInterval=null,d.intervals.watchInterval=null);this.processFnRef=null;this.clear()}}var U=new K;U.init();d.recordingManager=U;window.HeatmapRecordings={srEventQueue:new L({maxBatchSize:64,minBatchSize:16,processingDelay:4E3,adaptiveTiming:!0,minProcessingDelay:4E3,maxProcessingDelay:8E3,maxHoldTime:8E3,sortEvents:!0,mutationMergeWindow:50}),startRecording:()=>{d.recordingManager.startRecording()},stopRecording:()=>
{d.recordingManager.stopRecording()},startRecordingMutations:()=>{d.recordingManager.startRecordingMutations()},stopRecordingMutations:()=>{d.recordingManager.stopRecordingMutations()},setRecordingEnabled:a=>{d.recordingsEnabled=!!a},setCaptureKeystrokes:a=>{d.captureKeystrokes=!!a},setCaptureMovements:a=>{d.captureMovements=!!a},setTransport:a=>{if("http"===a||"websocket"===a)y.transport=a,r(`Transport set to: ${a}`)},getTransport:()=>y.transport,processEventQueue:(a={})=>{window.HeatmapRecordings.srEventQueue.process(F,
a).catch(b=>{setTimeout(()=>window.HeatmapRecordings.processEventQueue(a),1E3)})},clearEventQueue:()=>{window.HeatmapRecordings.srEventQueue.clear()},getQueueLength:()=>window.HeatmapRecordings.srEventQueue.length(),enableClickTrigger:(a=!0)=>{window.HeatmapRecordings.srEventQueue.watchForClicks(a)},triggerImmediateProcessing:()=>{window.HeatmapRecordings.srEventQueue.triggerImmediateProcessing()},beginInactivityDetection:()=>{d.intervals.inactivityInterval&&clearInterval(d.intervals.inactivityInterval);
d.intervals.inactivityInterval=setInterval(()=>{3E5<Date.now()-d.recentUserActivityTimestamp&&(window.HeatmapRecordings.stopRecordingProcess(),clearInterval(d.intervals.inactivityInterval),d.intervals.inactivityInterval=null,r("Stopped recording due to inactivity"))},6E4)},stopRecordingProcess:()=>{window.HeatmapRecordings.stopRecording();window.HeatmapRecordings.stopRecordingMutations();window.HeatmapRecordings.triggerImmediateProcessing();window.HeatmapRecordings.enableClickTrigger(!1);d.recordingClient&&
d.recordingClient.disconnect();r("Recording process stopped")},isRecording:()=>d.recordingManager.isRecording,isRecordingMutations:()=>d.recordingManager.isRecordingMutations,getScrollPercentage:()=>d.recordingManager.scrollMaxPercentage/10,loadCachedAuth(){try{const a=JSON.parse(localStorage.getItem("heatmap_recording_auth")),b=Date.now(),c=a.timestamp+36E5*a.expiryHours;a&&b<c&&a.idVisit===window.generatedIdVisit&&(this.cachedAuth=a)}catch(a){}},addStateMonitoring(){d.intervals.healthCheckInterval&&
clearInterval(d.intervals.healthCheckInterval);d.intervals.healthCheckInterval=setInterval(()=>{var a=Date.now();a={instanceId:d.id,queueLength:window.HeatmapRecordings.srEventQueue.length(),processingLock:window.HeatmapRecordings.srEventQueue.processingLock,clientConnected:d.recordingClient?d.recordingClient.connected:!1,clientType:y.transport,lastActivityAge:a-d.recentUserActivityTimestamp,recordingEnabled:d.recordingsEnabled,isPageVisible:d.isPageVisible};console.log("%c [Heatmap Health Check]",
"background-color: #009688; color: #fff; padding: 3px 5px;",a);a.processingLock&&6E4<a.lastActivityAge&&console.warn("Processing lock has been held for over 60 seconds - may be stuck");100<a.queueLength&&console.warn("Large queue but not processing - system may be stalled");!a.clientConnected&&d.recordingsEnabled&&console.warn(`${a.clientType} client disconnected but recording still enabled`)},3E4);window.heatmapHealthCheck=d.intervals.healthCheckInterval},destroyAndReset:function(){console.log("%c [Heatmap] Destroying instance #"+
d.id,"background-color: #f44336; color: #fff; padding: 5px;");this.stopRecording();this.stopRecordingMutations();this.srEventQueue&&(this.srEventQueue.destroy(),this.srEventQueue=null);d.recordingClient&&(d.recordingClient.disconnect(),d.recordingClient=null);Object.values(d.intervals).forEach(a=>{a&&clearInterval(a)});d.intervals={};d.recordingManager&&(d.recordingManager.cleanup(),d.recordingManager=null);d.heatUrlChangeHandler&&window.removeEventListener("HeatUrlChange",d.heatUrlChangeHandler);
d.beforeUnloadHandler&&window.removeEventListener("beforeunload",d.beforeUnloadHandler);window.HeatmapInitFunction()},toggleTQASession:function(){try{window.IS_TQA_SESSION=!window.IS_TQA_SESSION,"undefined"!==typeof localStorage&&localStorage.setItem("IS_TQA_SESSION",window.IS_TQA_SESSION),r(`TQA recording ${window.IS_TQA_SESSION?"enabled":"disabled"}`)}catch(a){console.warn("Could not persist TQA session state:",a)}},fetchInitialDOMData:async function(a,b,c,e){try{const f=new URLSearchParams({idsite:a,
deviceType:b,url:c,heatmap_hsr:e});return await (await fetch(`${y.http.url}record/get-initial-dom?${f}`,{method:"GET",headers:{"Content-Type":"application/json"}})).json()}catch(f){}return null},saveInitialDOMData:async function(a,b,c,e,f){try{const g=await fetch(`${y.http.url}record/save-initial-dom`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idsite:a,deviceType:b,url:c,heatmap_hsr:e,domContent:f})});if(!g.ok)throw Error(`HTTP error! status: ${g.status}`);return await g.json()}catch(g){return console.error("Error saving initial DOM data:",
g),{success:!1,error:"Failed to save initial DOM data"}}},_instance:d};(function(){try{const b=(new URLSearchParams(window.location.search)).get("tqa");window.IS_TQA_SESSION="true"===b;if("undefined"!==typeof localStorage)if(window.IS_TQA_SESSION)localStorage.setItem("IS_TQA_SESSION",window.IS_TQA_SESSION);else{var a=localStorage.getItem("IS_TQA_SESSION");window.IS_TQA_SESSION="true"===a}}catch(b){console.warn("Could not access localStorage for TQA session:",b),window.IS_TQA_SESSION=!1}})();var C=
function(a){const b=a.transport||"http";r(`Creating ${b} recording client (HTTP is default)`);return"http"===b?new I({...a.http,debug:a.debug||!1}):new J({...a.websocket,debug:a.debug||!1})}(y);d.recordingClient=C;C.on("open",()=>{r(`${y.transport.toUpperCase()} connection established`)});C.on("handshakeResponse",a=>{r("Recording status:",a.shouldRecord?"Enabled":"Disabled")});C.on("close",a=>{r(`${y.transport.toUpperCase()} connection closed:`,a.code||"N/A",a.reason||"Client disconnected")});C.on("error",
a=>{r(`${y.transport.toUpperCase()} error:`,a)});window.recordingClient=C;d.heatUrlChangeHandler=()=>{console.log("%c [Heatmap] URL change detected - resetting recording","background-color: #FF9800; color: #fff; padding: 5px;");window.HeatmapRecordings._resetting||(window.HeatmapRecordings._resetting=!0,window.HeatmapRecordings.destroyAndReset(),setTimeout(()=>{window.HeatmapRecordings._resetting=!1},1E3))};d.beforeUnloadHandler=()=>{for(const a of d.disconnectHandlers)try{a()}catch(b){console.warn("Error in disconnect handler:",
b)}window.HeatmapRecordings.stopRecordingProcess()};window.addEventListener("HeatUrlChange",d.heatUrlChangeHandler);window.addEventListener("beforeunload",d.beforeUnloadHandler);window.HeatmapRecordings.addDisconnectHandler=a=>{"function"===typeof a&&d.disconnectHandlers.push(a)};(()=>{if(C.connected)window.HeatmapRecordings.startRecording(),window.HeatmapRecordings.startRecordingMutations(),window.HeatmapRecordings.processEventQueue(),window.HeatmapRecordings.enableClickTrigger(),window.HeatmapRecordings.beginInactivityDetection();
else C.on("open",()=>{window.HeatmapRecordings.startRecording();window.HeatmapRecordings.startRecordingMutations();window.HeatmapRecordings.processEventQueue();window.HeatmapRecordings.enableClickTrigger();window.HeatmapRecordings.beginInactivityDetection()})})();console.log(`%c [Heatmap] Recording system initialized (instance #${G}) with ${y.transport.toUpperCase()} transport (HTTP default)`,"background-color: #4CAF50; color: #fff; padding: 5px;");window._heatmapRecordingsInstalled=!0}});return d.id}}(),
window.HeatmapInitFunction(),window.addEventListener("HeatUrlChange",function(){console.log("URL change detected - resetting recording");!window.HeatmapRecordings._resetting&&window.HeatmapRecordings&&"function"===typeof window.HeatmapRecordings.destroyAndReset&&(window.HeatmapRecordings._resetting=!0,window.HeatmapRecordings.destroyAndReset(),setTimeout(()=>{window.HeatmapRecordings._resetting=!1},1E3))}),window.HeatmapRecordingConfig={setTransport:function(q){"http"===q||"websocket"===q?(window.HeatmapRecordingTransport=
q,console.log(`%c [Heatmap Config] Transport set to: ${q}`,"background-color: #9C27B0; color: #fff; padding: 3px 5px;"),window.HeatmapRecordings&&"function"===typeof window.HeatmapRecordings.setTransport&&window.HeatmapRecordings.setTransport(q)):console.warn('[Heatmap Config] Invalid transport type. Use "http" or "websocket"')},configureHttp:function(q){"object"===typeof q&&(window.HeatmapRecordingHttpConfig={...window.HeatmapRecordingHttpConfig,...q},console.log("%c [Heatmap Config] HTTP config updated:",
"background-color: #FF5722; color: #fff; padding: 3px 5px;",q))},configureWebSocket:function(q){"object"===typeof q&&(window.HeatmapRecordingWebSocketConfig={...window.HeatmapRecordingWebSocketConfig,...q},console.log("%c [Heatmap Config] WebSocket config updated:","background-color: #43a047; color: #fff; padding: 3px 5px;",q))},setMutationMergeWindow:function(q){"number"===typeof q&&0<=q&&window.HeatmapRecordings&&window.HeatmapRecordings.srEventQueue&&(window.HeatmapRecordings.srEventQueue.config.mutationMergeWindow=
q,console.log(`%c [Heatmap Config] Mutation merge window set to ${q}ms`,"background-color: #9C27B0; color: #fff; padding: 3px 5px;"))},getMutationMergeStats:function(){return window.HeatmapRecordings&&window.HeatmapRecordings.srEventQueue?window.HeatmapRecordings.srEventQueue.getMutationMergeStats():{total:0,merged:0,skipped:0,errors:0,mergeRate:"0.00%",mergeWindow:0}},getConfig:function(){return{transport:window.HeatmapRecordingTransport||"http",http:window.HeatmapRecordingHttpConfig||{},websocket:window.HeatmapRecordingWebSocketConfig||
{},queueSettings:window.HeatmapRecordings&&window.HeatmapRecordings.srEventQueue?{mutationMergeWindow:window.HeatmapRecordings.srEventQueue.config.mutationMergeWindow,maxBatchSize:window.HeatmapRecordings.srEventQueue.config.maxBatchSize,minBatchSize:window.HeatmapRecordings.srEventQueue.config.minBatchSize}:{}}},enableDebug:function(){window._heatmapRecordingsDebug=!0;console.log("%c [Heatmap Config] Debug mode enabled","background-color: #673AB7; color: #fff; padding: 3px 5px;")},disableDebug:function(){window._heatmapRecordingsDebug=
!1;console.log("%c [Heatmap Config] Debug mode disabled","background-color: #673AB7; color: #fff; padding: 3px 5px;")}},(window._heatDEBUG||window._heatmapRecordingsDebug)&&console.log("%c\nHeatmap Recordings Configuration API:\n\n// Default: HTTP transport (recommended)\n// Switch to WebSocket transport (backward compatibility)\nHeatmapRecordingConfig.setTransport('websocket');\n\n// Switch back to HTTP transport (default)\nHeatmapRecordingConfig.setTransport('http');\n\n// Configure HTTP client (default transport)\nHeatmapRecordingConfig.configureHttp({\n  handshakeUrl: 'https://api.yourserver.com/v1/handshake',\n  timeout: 15000\n});\n\n// Configure WebSocket client (backward compatibility)\nHeatmapRecordingConfig.configureWebSocket({\n  url: 'wss://ws.yourserver.com/record',\n  heartbeatInterval: 45000\n});\n\n// Get current config\nconsole.log(HeatmapRecordingConfig.getConfig());\n\n// Enable debug logging\nHeatmapRecordingConfig.enableDebug();\n    ",
"background-color: #E1F5FE; color: #01579B; padding: 10px; font-family: monospace;"))})();
